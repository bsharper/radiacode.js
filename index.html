<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>RadiaCode.js</title>
<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="192x192" href="images/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="images/android-chrome-512x512.png">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-apexcharts"></script>
<script src="smoothie.js"></script>
<script src="radiacode.js"></script>

</head>
<link rel="stylesheet" href="css/fontello.css">
<link rel="stylesheet" href="css/animation.css">
<link rel="stylesheet" href="css/main.css">
<body>
<div id="app">
  <!-- Connection Controls -->
  <div class="connection-controls">
    <div class="connection-header">
      <h3>Device Connection</h3>
      
      <!-- Device Status Indicators (Battery & Temperature) -->
      <div class="device-status-indicators" v-if="isConnected && deviceStatus.hasRareData">
        <div class="battery-indicator" 
             v-if="deviceStatus.batteryLevel !== null" 
             :class="batteryClass"
             :style="{ borderColor: batteryColor }"
             :title="`Battery: ${deviceStatus.batteryLevel}%`">
          <span class="battery-icon">{{ batteryIcon }}</span>
          <span class="battery-percentage">{{ deviceStatus.batteryLevel }}%</span>
        </div>
        <div class="temperature-indicator" v-if="deviceStatus.temperature !== null" :title="`Temperature: ${deviceStatus.temperature.toFixed(1)}°C / ${celsiusToFahrenheit(deviceStatus.temperature).toFixed(1)}°F`">
          <span class="temperature-icon">🌡️</span>
          <span class="temperature-values">{{ deviceStatus.temperature.toFixed(1) }}°C / {{ celsiusToFahrenheit(deviceStatus.temperature).toFixed(1) }}°F</span>
        </div>
      </div>
    </div>
    <div class="connection-row">
      <div class="connection-buttons">
        <button 
          class="connection-button connect-bluetooth" 
          @click="connectBluetooth" 
          :disabled="isConnected || isConnecting"
          title="Connect via Bluetooth"
          aria-label="Connect via Bluetooth">
          <i class="icon-bluetooth-b" aria-hidden="true"></i><span class="sr-only">Bluetooth</span>
        </button>
        <button 
          class="connection-button connect-usb" 
          @click="connectUSB" 
          :disabled="isConnected || isConnecting"
          title="Connect via USB"
          aria-label="Connect via USB">
          <i class="icon-usb" aria-hidden="true"></i><span class="sr-only">USB</span>
        </button>
        <button 
          class="connection-button disconnect" 
          @click="disconnect" 
          :disabled="!isConnected"
          title="Disconnect device" aria-label="Disconnect device">
          🔌<span class="sr-only">Disconnect</span>
        </button>
      </div>
      
      <div :class="['status', connectionStatus.toLowerCase()]">
        {{ connectionStatusText }}
        <span v-if="isConnected && autoUpdateEnabled" style="margin-left: 10px; font-size: 0.9em;">({{ updateInterval/1000 }}s interval)</span>
      </div>
    </div>
    
    <div class="log-section" v-if="logMessages.length > 0">
      <div class="log-header" @click="toggleLogExpanded">
        <div class="log-header-left">
          <span class="log-toggle-icon">{{ logExpanded ? '▼' : '▶' }}</span>
          <span>Activity Log ({{ logMessages.length }} messages)</span>
          <span v-if="logExpanded && !logAutoScroll" class="auto-scroll-indicator">Scroll paused</span>
        </div>
        <button @click.stop="clearLog" class="clear-log-button">Clear</button>
      </div>
      <div class="log" v-show="logExpanded" ref="logContainer" @scroll.passive="handleLogScroll">
        <div v-for="msg in visibleLogMessages" :key="msg.id" class="log-entry">
          <span class="log-timestamp">{{ msg.timestamp }}</span> 
          <span class="log-message">{{ msg.message }}</span>
        </div>
        <div v-if="logMessages.length > maxVisibleMessages" class="log-entry log-info">
          ... {{ logMessages.length - maxVisibleMessages }} earlier messages (scroll to top to load)
        </div>
      </div>
    </div>
  </div>

  <!-- Device Panel: Controls + Information Side by Side -->
  <div class="device-panel" v-if="isConnected">
    <div class="device-controls">
      <h3 style="margin-top:0;">Device Controls</h3>
      <div class="device-control-buttons">
        <button 
          class="device-button auto-update" 
          @click="toggleAutoUpdate">
          Auto-update: {{ autoUpdateEnabled ? 'ON' : 'OFF' }}
        </button>
        <button 
          class="device-button alarm-settings" 
          @click="loadAlarmSettings">
          View Alarm Settings
        </button>
        <button 
          class="device-button sound-toggle" 
          @click="toggleSound" 
          :disabled="soundEnabled === null">
          {{ soundEnabled ? '🔊 Sound: ON' : '🔈 Sound: OFF' }}
        </button>
        <button 
          class="device-button spectrum-update" 
          @click="updateSpectrum">
          Update Spectrum
        </button>
        <button 
          class="device-button spectrum-reset" 
          @click="requestSpectrumReset()">
          Reset Spectrum
        </button>
        <button 
          class="device-button rates-clear" 
          @click="requestRatesClear()" 
          :disabled="!(rates_series[0]?.data?.length)">
          Clear Rates
        </button>
        <button
          class="device-button reload-ui"
          @click="reloadUI">
          🔁 Reload UI
        </button>
        <button
          class="device-button test-battery"
          @click="testBatteryLevels"
          title="Test different battery level indicators">
          🔋 Test Battery
        </button>
      </div>
    </div>
    <div class="device-info">
      <h3 style="margin-top:0;">Device Information</h3>
      <div class="device-info-grid">
        <div class="device-info-item">
          <label>Serial Number:</label>
          <span>{{ deviceInfo.serialNumber || 'Loading...' }}</span>
        </div>
        <div class="device-info-item">
          <label>Firmware Version:</label>
          <span>{{ deviceInfo.firmwareVersion || 'Loading...' }}</span>
        </div>
        <div class="device-info-item">
          <label>Connection Type:</label>
          <span>{{ deviceInfo.connectionType || 'Unknown' }}</span>
        </div>
        <div class="device-info-item">
          <label>Last Update:</label>
          <span>{{ deviceInfo.lastUpdate || 'Never' }}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alarm Limits -->
  <div class="alarm-limits" v-if="isConnected && alarmLimits">
    <h3>Alarm Limits</h3>
    <div class="alarm-limits-grid">
      <div class="alarm-item">
        <label>Count Rate L1/L2:</label>
        <span>{{ alarmLimits.l1_count_rate.toFixed(1) }} / {{ alarmLimits.l2_count_rate.toFixed(1) }} {{ alarmLimits.count_unit }}</span>
      </div>
      <div class="alarm-item">
        <label>Dose Rate L1/L2:</label>
        <span>{{ alarmLimits.l1_dose_rate.toFixed(1) }} / {{ alarmLimits.l2_dose_rate.toFixed(1) }} µ{{ alarmLimits.dose_unit }}/h</span>
      </div>
      <div class="alarm-item">
        <label>Dose L1/L2:</label>
        <span>{{ alarmLimits.l1_dose.toFixed(1) }} / {{ alarmLimits.l2_dose.toFixed(1) }} µ{{ alarmLimits.dose_unit }}</span>
      </div>
    </div>
  </div>

  <!-- Real-time Data -->
  <div class="realtime-data" v-if="isConnected">
    <h3>Real-time Data</h3>
    <div class="realtime-grid">
      <div class="realtime-item">
        <div class="label">Count Rate</div>
        <span class="value">
          {{ currentData.countRate.toFixed(2) }}
          <span class="unit-inline">CPS</span>
          <span class="error">± {{ currentData.countRateError.toFixed(2) }}</span>
        </span>
        <div class="minmax-pill">
          <span class="pill-min">Min {{ stats.countRate.min == null ? '-' : stats.countRate.min.toFixed(2) }}</span>
          <span class="pill-max">Max {{ stats.countRate.max == null ? '-' : stats.countRate.max.toFixed(2) }}</span>
        </div>
      </div>
      <div class="realtime-item">
        <div class="label">Dose Rate</div>
        <span class="value">
          {{ currentData.doseRate.toFixed(4) }}
          <span class="unit-inline">µSv/h</span>
          <span class="error">± {{ currentData.doseRateError.toFixed(4) }}</span>
        </span>
        <div class="minmax-pill">
          <span class="pill-min">Min {{ stats.doseRate.min == null ? '-' : stats.doseRate.min.toFixed(4) }}</span>
          <span class="pill-max">Max {{ stats.doseRate.max == null ? '-' : stats.doseRate.max.toFixed(4) }}</span>
        </div>
      </div>
    </div>
    <div class="realtime-grid">
      <div class="chart-container">
        <h4 style="margin-top: 0; color: #155724;">Count Rate (CPS)</h4>
        <canvas id="countRateChart"></canvas>
      </div>
      <div class="chart-container">
        <h4 style="margin-top: 0; color: #155724;">Dose Rate (µSv/h)</h4>
        <canvas id="doseRateChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Spectrum Chart -->
  <div>
    <apexchart type="bar" height="350" :options="spectrumChartOptions" :series="spectrum_series"></apexchart>
    <div>
      <fieldset>
        <input type="checkbox" id="spectrum_x_accum" v-model="spectrum_accum">
        <label for="spectrum_x_accum">Accumulated</label>
      </fieldset>
      <fieldset>
        <input type="radio" id="spectrum_x_channel" v-bind:value="false" v-model="spectrum_energy">
        <label for="spectrum_x_channel">Channel</label>

        <input type="radio" id="spectrum_x_energy" v-bind:value="true" v-model="spectrum_energy">
        <label for="spectrum_x_energy">Energy</label>
      </fieldset>
      <fieldset>
        <input type="radio" id="spectrum_linear" v-bind:value="false" v-model="spectrum_logarithmic">
        <label for="spectrum_linear">Linear</label>
        <input type="radio" id="spectrum_log" v-bind:value="true" v-model="spectrum_logarithmic">
        <label for="spectrum_log">Logarithmic</label>
      </fieldset>
    </div>
  </div>

  <!-- Rates Chart -->
  <div>
    <apexchart type="line" height="350" :options="ratesChartOptions" :series="rates_series"></apexchart>
    <div>
      <span v-if="rates_series.length > 0">
        Data points: {{ rates_series[0]?.data?.length || 0 }}
      </span>
    </div>
  </div>

  <!-- Recording / Storage Section -->
  <div class="storage-section" v-if="isConnected">
    <div class="storage-head">
      <div class="storage-head-left">
        <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
          <span>Recording</span>
          <span class="record-indicator" :class="{on: storage.enabled}">
            <span class="dot"></span><span class="label">{{ storage.enabled ? 'ON' : 'OFF' }}</span>
          </span>
        </h3>
        <div class="storage-meta">
          <span title="Total samples persisted">Samples: <strong>{{ storage.totalSamples }}</strong></span>
          <span v-if="storage.sizeBytes" title="Approx persisted size"> · Size ~{{ (storage.sizeBytes/1024).toFixed(1) }} KB</span>
          <span v-if="storage.buffer.length" title="Buffered (not yet flushed)"> · Buffer {{ storage.buffer.length }}</span>
          <span v-if="!storage.enabled" class="paused-tag">Paused</span>
          <span v-if="storage.usingIndexedDB" class="idb-tag" title="IndexedDB active">IndexedDB</span>
          <span v-else class="fallback-tag" title="Fallback to localStorage">localStorage</span>
        </div>
      </div>
      <div class="storage-actions">
        <button class="btn" @click="toggleStorage">{{ storage.enabled ? 'Pause' : 'Resume' }}</button>
        <button class="btn" @click="exportStoredSamples" :disabled="!storage.totalSamples">Export JSON</button>
        <button class="btn warn" @click="clearStoredSamples" :disabled="!storage.totalSamples">Clear</button>
        <button class="btn ghost" @click="samplesTableExpanded = !samplesTableExpanded" :disabled="!storage.totalSamples">
          {{ samplesTableExpanded ? 'Hide' : 'Show' }} Table
        </button>
      </div>
    </div>
    <transition name="fade-slide">
      <div v-show="samplesTableExpanded" class="samples-wrapper">
        <div class="samples-toolbar">
          <span>Recent Samples (last {{ sampleRowLimit }} shown)</span>
          <div class="toolbar-right">
            <label class="chk"><input type="checkbox" v-model="autoScrollSamples"> Auto-scroll</label>
            <label class="chk"><input type="checkbox" v-model="highlightNewSamples"> Highlight new</label>
            <select v-model.number="sampleRowLimit">
              <option :value="100">100</option>
              <option :value="200">200</option>
              <option :value="500">500</option>
            </select>
          </div>
        </div>
        <div class="samples-table-scroll" ref="samplesScroll" @scroll.passive="handleSamplesScroll">
          <table class="samples-table">
            <thead>
              <tr>
                <th>Time</th>
                <th title="Count Rate">CR (CPS)</th>
                <th title="Dose Rate">DR (µSv/h)</th>
                <th title="Count Rate Error">CR ±</th>
                <th title="Dose Rate Error">DR ±</th>
                <th>Flags</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="row in sampleRows" :key="row.id" :class="{'new-sample': highlightNewSamples && row._flash}">
                <td>{{ row.time }}</td>
                <td>{{ row.cr.toFixed(2) }}</td>
                <td>{{ row.dr.toFixed(6) }}</td>
                <td>{{ row.crErr.toFixed(2) }}</td>
                <td>{{ row.drErr.toFixed(6) }}</td>
                <td>{{ row.flagsHex }}</td>
              </tr>
              <tr v-if="!sampleRows.length">
                <td colspan="6" style="text-align:center; padding:12px; color:#888;">No samples yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </transition>
  </div>

  <!-- Reusable Confirmation Modal -->
  <div v-if="confirmDialog.visible" class="confirm-backdrop" @click.self="closeConfirm()">
    <div class="confirm-modal" role="dialog" aria-modal="true" :aria-label="confirmDialog.title">
      <div class="confirm-header">
        <span class="confirm-title">{{ confirmDialog.title }}</span>
        <button class="confirm-close" @click="closeConfirm()" aria-label="Close">×</button>
      </div>
      <div class="confirm-body">
        <div class="confirm-icon" aria-hidden="true">⚠️</div>
        <div class="confirm-message">{{ confirmDialog.message }}</div>
      </div>
      <div class="confirm-actions">
        <button class="confirm-cancel" @click="closeConfirm()">{{ confirmDialog.cancelLabel || 'Cancel' }}</button>
        <button class="confirm-ok" @click="confirmRun()">{{ confirmDialog.confirmLabel || 'Confirm' }}</button>
      </div>
    </div>
  </div>
</div>

<footer style="margin-top: 24px; padding: 12px 16px; color:#666; font-size: 12px; border-top: 1px solid #eee;">
  RadiaCode.js <span id="lib-version">v?</span>
  <span style="margin-left:8px; color:#aaa;">— Demo UI</span>
  <span style="float:right; color:#aaa;">Firmware info appears after connect</span>
  <div style="clear:both"></div>  
</footer>

<script src="app.js"></script></body>
</html>
